#!/bin/bash
# FINALIZACAO_COBRANCA-API_VPS.SH
# Script completo para finalizar a configuraÃ§Ã£o da VPS
# Execute este script na VPS (IP: 76.13.167.54)

set -e

echo "=========================================="
echo "ğŸš€ FINALIZANDO COBRANCA-API VPS"
echo "=========================================="
echo ""

# Definir caminho do projeto
PROJECT_PATH="/var/www/cobranca-api"
DOMAIN="api.cobrancaauto.com.br"
EMAIL="seu@email.com"

# Ir para o diretÃ³rio do projeto
cd "$PROJECT_PATH" || {
    echo "âŒ Erro: DiretÃ³rio $PROJECT_PATH nÃ£o encontrado"
    exit 1
}

echo "ğŸ“ DiretÃ³rio do projeto: $PROJECT_PATH"
echo "ğŸŒ DomÃ­nio: $DOMAIN"
echo ""

# ============================================
# PASSO 1: Resolver conflito de porta 80
# ============================================
echo "=========================================="
echo "ğŸ“‹ PASSO 1: Resolvendo conflito de porta 80"
echo "=========================================="

# Identificar containers usando portas 80/443
echo "ğŸ” Identificando containers usando portas 80/443..."
docker ps -a --filter "publish=80" --format "table {{.Names}}\t{{.Ports}}\t{{.Status}}" || true
docker ps -a --filter "publish=443" --format "table {{.Names}}\t{{.Ports}}\t{{.Status}}" || true

# Parar containers que usam porta 80/443
PROXY_CONTAINERS=$(docker ps -a --filter "publish=80" --format "{{.Names}}" 2>/dev/null || true)

if [ -n "$PROXY_CONTAINERS" ]; then
    echo ""
    echo "ğŸ›‘ Parando containers que usam porta 80/443..."
    for container in $PROXY_CONTAINERS; do
        echo "  - Parando $container..."
        docker stop "$container" 2>/dev/null || true
        docker rm "$container" 2>/dev/null || true
    done
fi

echo ""
echo "âœ… Conflito de porta 80 resolvido"
echo ""

# ============================================
# PASSO 2: Subir MySQL
# ============================================
echo "=========================================="
echo "ğŸ“‹ PASSO 2: Subindo MySQL"
echo "=========================================="

echo "ğŸ³ Subindo containers MySQL..."
docker compose -f docker-compose.mysql.yml up -d

echo "â³ Aguardando MySQL iniciar (10 segundos)..."
sleep 10

echo "ğŸ“‹ Logs do MySQL:"
docker compose -f docker-compose.mysql.yml logs --tail=10

echo ""
echo "âœ… MySQL iniciado com sucesso"
echo ""

# ============================================
# PASSO 3: Configurar Nginx para o domÃ­nio
# ============================================
echo "=========================================="
echo "ğŸ“‹ PASSO 3: Configurando Nginx para $DOMAIN"
echo "=========================================="

echo "ğŸ“ Criando configuraÃ§Ã£o do Nginx..."
cat > /etc/nginx/sites-available/cobranca-api << 'EOF'
server {
    listen 80;
    listen [::]:80;
    server_name api.cobrancaauto.com.br www.api.cobrancaauto.com.br;

    root /root/cobranca-api/public;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";
    add_header X-XSS-Protection "1; mode=block";

    index index.php index.html index.htm;

    charset utf-8;

    access_log /var/log/nginx/cobranca-api-access.log;
    error_log /var/log/nginx/cobranca-api-error.log;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        fastcgi_pass 127.0.0.1:8082;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_param PATH_INFO $fastcgi_path_info;

        fastcgi_read_timeout 300;
        fastcgi_send_timeout 300;
    }

    location ~ /\. {
        deny all;
    }

    client_max_body_size 100M;
    fastcgi_buffer_size 128k;
    fastcgi_buffers 4 256k;
}
EOF

# Ativar o site
ln -sf /etc/nginx/sites-available/cobranca-api /etc/nginx/sites-enabled/cobranca-api

# Remover configuraÃ§Ã£o padrÃ£o
rm -f /etc/nginx/sites-enabled/default

# Testar configuraÃ§Ã£o
echo "ğŸ” Testando configuraÃ§Ã£o do Nginx..."
nginx -t

# Reiniciar Nginx
echo "ğŸš€ Reiniciando Nginx..."
systemctl restart nginx

echo "ğŸ“‹ Status do Nginx:"
systemctl status nginx --no-pager

echo ""
echo "âœ… Nginx configurado com sucesso"
echo ""

# ============================================
# PASSO 4: Configurar HTTPS com Certbot
# ============================================
echo "=========================================="
echo "ğŸ“‹ PASSO 4: Configurando HTTPS com Certbot"
echo "=========================================="

echo "ğŸ“¦ Atualizando pacotes..."
apt update

echo "ğŸ“¦ Instalando Certbot..."
apt install -y certbot python3-certbot-nginx

echo "ğŸ” Obtendo certificado SSL para $DOMAIN..."
certbot --nginx -d "$DOMAIN" -d "www.$DOMAIN" --non-interactive --agree-tos --email "$EMAIL"

echo ""
echo "âœ… HTTPS configurado com sucesso"
echo ""

# ============================================
# PASSO 5: Configurar Laravel Trust Proxies (Cloudflare)
# ============================================
echo "=========================================="
echo "ğŸ“‹ PASSO 5: Configurando Trust Proxies para Cloudflare"
echo "=========================================="

echo "ğŸ“ Atualizando bootstrap/app.php para confiar em todos os proxies..."
# Fazer backup do arquivo original
cp bootstrap/app.php bootstrap/app.php.backup

# Adicionar configuraÃ§Ã£o de trust proxies
sed -i '/->withMiddleware(function (Middleware \$middleware): void {/a\
        $middleware->trustProxies(at: [\
            '*',\
        ]);' bootstrap/app.php

echo "ğŸ”„ Limpando cache de configuraÃ§Ã£o..."
php artisan config:clear
php artisan config:cache

echo ""
echo "âœ… Trust Proxies configurado com sucesso"
echo ""

# ============================================
# PASSO 6: Configurar .env de produÃ§Ã£o
# ============================================
echo "=========================================="
echo "ğŸ“‹ PASSO 6: Configurando .env de produÃ§Ã£o"
echo "=========================================="

if [ ! -f .env ]; then
    echo "ğŸ“ Criando arquivo .env a partir de .env.example..."
    cp .env.example .env
else
    echo "âš ï¸  Arquivo .env jÃ¡ existe, fazendo backup..."
    cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
fi

echo "ğŸ”‘ Gerando APP_KEY..."
php artisan key:generate

echo ""
echo "âš ï¸  IMPORTANTE: Edite o arquivo .env manualmente para configurar:"
echo "   - DB_PASSWORD (senha do MySQL)"
echo "   - APP_URL=https://$DOMAIN"
echo "   - MAIL_* (configuraÃ§Ãµes de email)"
echo "   - Outras variÃ¡veis necessÃ¡rias"
echo ""
echo "   Comando para editar: nano .env"
echo ""

# ============================================
# PASSO 7: Executar migraÃ§Ãµes
# ============================================
echo "=========================================="
echo "ğŸ“‹ PASSO 7: Executando migraÃ§Ãµes"
echo "=========================================="

echo "ğŸ”„ Executando migraÃ§Ãµes do banco de dados..."
php artisan migrate --force

echo "ğŸŒ± Executando seeders (opcional)..."
php artisan db:seed --force || echo "âš ï¸  Seeders nÃ£o executados (erro ou nÃ£o existem)"

echo ""
echo "âœ… MigraÃ§Ãµes executadas com sucesso"
echo ""

# ============================================
# PASSO 8: Configurar permissÃµes
# ============================================
echo "=========================================="
echo "ğŸ“‹ PASSO 8: Configurando permissÃµes"
echo "=========================================="

echo "ğŸ”§ Configurando permissÃµes de diretÃ³rios..."
chmod -R 755 storage bootstrap/cache
chown -R www-data:www-data storage bootstrap/cache || true

echo ""
echo "âœ… PermissÃµes configuradas com sucesso"
echo ""

# ============================================
# PASSO 9: Verificar status final
# ============================================
echo "=========================================="
echo "ğŸ“‹ PASSO 9: Verificando status final"
echo "=========================================="

echo "ğŸ“‹ Status do Nginx:"
systemctl status nginx --no-pager | head -10

echo ""
echo "ğŸ“‹ Containers Docker:"
docker ps

echo ""
echo "ğŸ“‹ Portas em uso:"
netstat -tlnp | grep -E ':(80|443|3306|8082)' || ss -tlnp | grep -E ':(80|443|3306|8082)'

echo ""
echo "ğŸ” Testando acesso HTTP:"
curl -I "http://$DOMAIN" 2>&1 || echo "âš ï¸  Erro ao testar HTTP"

echo ""
echo "ğŸ” Testando acesso HTTPS:"
curl -I "https://$DOMAIN" 2>&1 || echo "âš ï¸  Erro ao testar HTTPS"

echo ""
echo "=========================================="
echo "âœ… FINALIZAÃ‡ÃƒO CONCLUÃDA!"
echo "=========================================="
echo ""
echo "ğŸ‰ Resumo:"
echo "  âœ… Conflito de porta 80 resolvido"
echo "  âœ… MySQL iniciado"
echo "  âœ… Nginx configurado para $DOMAIN"
echo "  âœ… HTTPS configurado com Certbot"
echo "  âœ… Trust Proxies configurado para Cloudflare"
echo "  âœ… .env configurado"
echo "  âœ… MigraÃ§Ãµes executadas"
echo "  âœ… PermissÃµes configuradas"
echo ""
echo "ğŸ“ PrÃ³ximos passos:"
echo "  1. Edite o arquivo .env para configurar as variÃ¡veis necessÃ¡rias"
echo "  2. Reinicie o serviÃ§o Laravel se necessÃ¡rio"
echo "  3. Configure o DNS do domÃ­nio para apontar para o IP da VPS"
echo "  4. Configure o Cloudflare (se usar) para apontar para o domÃ­nio"
echo ""
echo "ğŸŒ Teste a aplicaÃ§Ã£o em: https://$DOMAIN/admin/saas/dashboard"
echo ""
